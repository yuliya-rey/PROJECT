{% extends "base.html" %}

{% block content %}
{% if not username %}
<div class="alert alert-info text-center">
    <h4>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫!</h4>
    <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, <a href="/login" class="alert-link">–≤–æ–π–¥–∏—Ç–µ</a> –∏–ª–∏ <a href="/register" class="alert-link">–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å</a> —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫.</p>
</div>
{% else %}

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4><i class="fas fa-list me-2"></i>–ú–æ–∏ –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è</h4>
                <span class="badge bg-primary">{{ tasks|length }} –∑–∞–¥–∞—á</span>
            </div>
            <div class="card-body">
                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
                <form method="post" action="/tasks/" class="mb-4">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <input type="text" name="title" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" required>
                        </div>
                        <div class="col-md-2">
                            <input type="time" name="task_time" class="form-control" required>
                        </div>
                        <div class="col-md-2">
                            <select name="priority" class="form-select" required>
                                <option value="low">üü¢ –ù–∏–∑–∫–∏–π</option>
                                <option value="medium">üü° –°—Ä–µ–¥–Ω–∏–π</option>
                                <option value="high">üü† –í—ã—Å–æ–∫–∏–π</option>
                                <option value="urgent">üî¥ –°—Ä–æ—á–Ω—ã–π</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select name="category" class="form-select" required>
                                <option value="work">üíº –†–∞–±–æ—Ç–∞</option>
                                <option value="personal">üè† –õ–∏—á–Ω–æ–µ</option>
                                <option value="health">üè• –ó–¥–æ—Ä–æ–≤—å–µ</option>
                                <option value="study">üìö –£—á–µ–±–∞</option>
                                <option value="shopping">üõí –ü–æ–∫—É–ø–∫–∏</option>
                                <option value="general">üìã –û–±—â–µ–µ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å
                            </button>
                        </div>
                        <div class="col-12">
                            <textarea name="description" class="form-control" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" rows="2"></textarea>
                        </div>
                    </div>
                </form>

                <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
                <div class="tasks-list">
                    {% for task in tasks %}
                    <div class="task-item card mb-2 priority-{{ task.priority }} category-{{ task.category }}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <input type="checkbox" class="form-check-input me-3 task-checkbox" 
                                           data-task-id="{{ task.id }}"
                                           {% if task.completed %}checked{% endif %}>
                                    <div>
                                        <h6 class="mb-1 {% if task.completed %}text-decoration-line-through text-muted{% endif %}">
                                            {{ task.title }}
                                        </h6>
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> {{ task.task_time }}
                                            <i class="fas fa-tag ms-2"></i> 
                                            {% if task.category == 'work' %}üíº –†–∞–±–æ—Ç–∞
                                            {% elif task.category == 'personal' %}üè† –õ–∏—á–Ω–æ–µ
                                            {% elif task.category == 'health' %}üè• –ó–¥–æ—Ä–æ–≤—å–µ
                                            {% elif task.category == 'study' %}üìö –£—á–µ–±–∞
                                            {% elif task.category == 'shopping' %}üõí –ü–æ–∫—É–ø–∫–∏
                                            {% else %}üìã –û–±—â–µ–µ{% endif %}
                                            {% if task.description %} | {{ task.description }}{% endif %}
                                        </small>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge me-2 priority-badge {{ task.priority }}">
                                        {% if task.priority == 'low' %}üü¢ –ù–∏–∑–∫–∏–π
                                        {% elif task.priority == 'medium' %}üü° –°—Ä–µ–¥–Ω–∏–π
                                        {% elif task.priority == 'high' %}üü† –í—ã—Å–æ–∫–∏–π
                                        {% else %}üî¥ –°—Ä–æ—á–Ω—ã–π{% endif %}
                                    </span>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" data-task-id="{{ task.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-tasks fa-3x mb-3"></i>
                        <p>–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–¥–∞—á—É!</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="card mb-3">
            <div class="card-header">
                <h5><i class="fas fa-chart-line me-2"></i>–ü—Ä–æ–≥—Ä–µ—Å—Å –¥–Ω—è</h5>
            </div>
            <div class="card-body text-center">
                {% set completed = tasks|selectattr("completed")|list|length %}
                {% set total = tasks|length %}
                {% set percentage = (completed / total * 100)|round(1) if total > 0 else 0 %}
                
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar bg-success progress-bar-striped" 
                         style="width: {{ percentage }}%">
                        {{ percentage }}%
                    </div>
                </div>
                <p><strong>–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ completed }} –∏–∑ {{ total }} –∑–∞–¥–∞—á</strong></p>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie me-2"></i>–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h5>
            </div>
            <div class="card-body">
                {% set categories = {
                    'work': 'üíº –†–∞–±–æ—Ç–∞',
                    'personal': 'üè† –õ–∏—á–Ω–æ–µ', 
                    'health': 'üè• –ó–¥–æ—Ä–æ–≤—å–µ',
                    'study': 'üìö –£—á–µ–±–∞',
                    'shopping': 'üõí –ü–æ–∫—É–ø–∫–∏',
                    'general': 'üìã –û–±—â–µ–µ'
                } %}
                
                {% for cat_key, cat_name in categories.items() %}
                    {% set cat_tasks = tasks|selectattr("category", "equalto", cat_key)|list %}
                    {% set cat_completed = cat_tasks|selectattr("completed")|list|length %}
                    {% set cat_total = cat_tasks|length %}
                    
                    {% if cat_total > 0 %}
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>{{ cat_name }}</span>
                            <span>{{ cat_completed }}/{{ cat_total }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" style="width: {{ (cat_completed / cat_total * 100) if cat_total > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
